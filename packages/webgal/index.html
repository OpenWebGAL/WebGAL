<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="./icons/favicon.ico" />
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />
    <link rel="stylesheet" href="./src/index.scss" />
    <link rel="stylesheet" href="./game/userStyleSheet.css" />
    <title>WebGAL</title>
  </head>
  <body>
    <!--先盖一层 LOGO 挡住下面正在加载的组件-->
    <div id="launchScreen" class="launch_screen">
      <div class="launch_screen_logo_container">
        <img id="gameLogo" alt="Game Logo" class="launch_screen_logo" />
      </div>
      <div class="launch_screen_loading_container">
        <div id="launchScreenLoadingBar" class="launch_screen_loading_bar">
          PLAY
        </div>
      </div>
    </div>
    <!-- 紧急回避页挂载点 -->
    <div id="panicOverlay"></div>
    <!-- 应用挂载点 -->
    <div id="root"></div>
    <!-- 加载 Logo -->
    <script type="module">
      import defaultLogo from './src/assets/logo/logo.png';
      (() => {
        function loadLogo(src) {
          const img = document.getElementById('gameLogo');
          img.onerror = function () {
            // 路径不存在时回退到默认 logo
            img.onerror = null; // 防止死循环
            img.src = defaultLogo;
          };
          img.src = src;
        }
        loadLogo('./game/logo.png');
      })();
    </script>
    <script>
      (() => {
        const isIOS = !!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);
        if (!isIOS) {
          // 非 IOS
          // 创建一个新的 meta 标签
          const metaTag = document.createElement('meta');
          metaTag.name = 'viewport';
          metaTag.content = 'width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no';
          // 将该标签添加到 head 中
          document.head.appendChild(metaTag);
        } else {
          // IOS
          const metaTag = document.createElement('meta');
          metaTag.name = 'viewport';
          metaTag.content = 'width=device-width, initial-scale=0.22, minimum-scale=0.01, maximum-scale=1';
          // 将该标签添加到 head 中
          document.head.appendChild(metaTag);
          const styleTag = document.createElement('style');
          styleTag.textContent = '* { font-synthesis: none !important; }';
          document.head.appendChild(styleTag);
        }
      })();
    </script>
    <!-- 注册 Service Worker -->
    <script>
      (() => {
        const isIOS = !!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);
        if ('serviceWorker' in navigator && !isIOS) {
          navigator.serviceWorker
            .register('./webgal-serviceworker.js')
            .then((reg) => {
              console.log('Registration succeeded. Scope is ' + reg.scope);
            })
            .catch((error) => {
              console.log('Registration failed with ' + error);
            });
        }
      })();
    </script>
    <!-- 首屏加载 -->
    <script>
      (() => {
        const isIOS = !!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);
        let enterPromiseResolve;
        const enterPromise = new Promise((res) => {
          enterPromiseResolve = res;
        });
        const renderPromise = new Promise((res) => {
          window.renderPromiseResolve = () => {
            res();
            delete window.renderPromiseResolve;
          };
        });
        // 将播放bgm的事件发送出去
        Promise.all([enterPromise, renderPromise]).then(() => {
          const event = new MouseEvent('click', {
            view: window,
            bubbles: true,
            cancelable: true,
          });
          const target = document.getElementById('enter_game_target');
          if (target) {
            target.dispatchEvent(event);
          }
        });

        const enter = () => {
          // 玩家任何时候都可以点击关闭 launchScreen，不需要阻止
          enterPromiseResolve();
        };

        const launchScreen = document.getElementById('launchScreen');
        if (launchScreen) {
          launchScreen.onclick = enter;
        }
      })();
    </script>
    <!-- 加载IIFE插件 -->
    <script>
      (() => {
        const loadScript = (url, type) => {
          return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = url;
            if (type) script.type = type;
            script.onload = () => resolve(`Loaded: ${url}`);
            script.onerror = () => reject(new Error(`Failed to load: ${url}`));
            document.head.appendChild(script);
          });
        };
        const loadIifePlugin = async (pluginPath) => {
          try {
            const info = await loadScript(pluginPath);
            console.log(info);
            return true;
          } catch (error) {
            console.warn(error);
            return false;
          }
        };
        // 尝试加载 Live2D SDK，
        // 只有在用户自行取得 Live2D 许可并放到下面的目录时，这里才可能加载成功。
        // 本项目 **没有** 引入 Live2D SDK
        // Attempt to load the Live2D SDK.
        // This will only succeed if the user has obtained a Live2D license and placed it in the directory below.
        // This project **does not** include the Live2D SDK.
        // Live2D SDK の読み込みを試みます。
        // ユーザーが Live2D ライセンスを取得し、以下のディレクトリに配置した場合のみ、読み込みが成功します。
        // このプロジェクトには Live2D SDK は**含まれていません**
        const live2d2Promise = loadIifePlugin('lib/live2d.min.js');
        const live2d4Promise = loadIifePlugin('lib/live2dcubismcore.min.js');
        window.live2dPromise = Promise.all([live2d2Promise, live2d4Promise]);
      })();
    </script>
    <!-- main文件 -->
    <script type="module" src="./src/main.tsx"></script>
  </body>
</html>
